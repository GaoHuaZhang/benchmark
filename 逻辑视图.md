分析 AISBench 的代码结构，绘制逻辑视图并描述。


[18 tools called]


查看关键模块的交互关系：


[4 tools called]


基于代码分析，绘制 AISBench 的逻辑视图并描述：

## AISBench 逻辑视图

### 逻辑视图图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户接口层 (CLI Layer)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │ ArgumentParser│  │ ConfigManager │  │ TaskManager  │                 │
│  │ 参数解析      │  │ 配置管理      │  │ 任务管理      │                 │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                 │
└─────────┼──────────────────┼──────────────────┼───────────────────────┘
          │                  │                  │
          └──────────────────┴──────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        工作流层 (Workflow Layer)                         │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │                    WorkFlowExecutor                            │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │     │
│  │  │  Infer   │  │   Eval   │  │   Perf   │  │  Summarize│     │     │
│  │  │  推理     │  │  评估    │  │  性能    │  │  汇总     │     │     │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │     │
│  └──────────────────────────────────────────────────────────────┘     │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                │                               │
                ▼                               ▼
┌───────────────────────────────┐  ┌───────────────────────────────┐
│      分区器层 (Partitioner)     │  │      运行器层 (Runner)         │
│  ┌──────────────────────────┐  │  │  ┌──────────────────────────┐ │
│  │  BasePartitioner          │  │  │  │  BaseRunner              │ │
│  │  ├─ NaivePartitioner     │  │  │  │  ├─ LocalRunner          │ │
│  │  ├─ SizePartitioner      │  │  │  │  └─ LocalAPIRunner       │ │
│  │  └─ SubPartitioner       │  │  │  │  └─ TasksMonitor         │ │
│  └──────────────────────────┘  │  │  └──────────────────────────┘ │
└───────────────┬────────────────┘  └───────────────┬────────────────┘
                │                                    │
                └──────────────┬─────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          任务层 (Task Layer)                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │ BaseTask         │  │ OpenICLApiInfer   │  │ OpenICLEvalTask   │  │
│  │                  │  │ Task              │  │                  │  │
│  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │
│  │ │TaskStateMgr  │ │  │ │推理任务管理   │ │  │ │评估任务管理   │ │  │
│  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
└───────────────┬──────────────────┬──────────────────┬────────────────┘
                │                  │                  │
    ┌───────────┴──────────┐       │       ┌──────────┴──────────┐
    │                      │       │       │                     │
    ▼                      ▼       ▼       ▼                     ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  模型层       │  │  数据集层    │  │  OpenICL层   │  │  结果汇总层   │
│ (Model)      │  │ (Dataset)    │  │              │  │ (Summarizer) │
├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────────┤
│ BaseModel    │  │ BaseDataset  │  │ BaseInferencer│  │ Default      │
│ ├─API Models │  │ ├─开源数据集  │  │ ├─API Infer  │  │ ├─Default    │
│ │ ├─VLLM     │  │ ├─合成数据集  │  │ ├─Local Infer│  │ ├─Perf       │
│ │ ├─Triton   │  │ └─自定义数据集│  │ ├─PPL Infer  │  │ └─Subjective │
│ │ └─TGI      │  │              │  │              │  │              │
│ └─Local Models│ │              │  │ BaseEvaluator │  │              │
│   ├─HF Models │  │              │  │ ├─Accuracy   │  │              │
│   └─vLLM Off │  │              │  │ └─Custom     │  │              │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
    │                  │                  │                  │
    └──────────────────┴──────────────────┴──────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        工具支撑层 (Utils Layer)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │ Config Utils │  │ Logging      │  │ File Utils    │                │
│  │ 配置工具      │  │ 日志系统      │  │ 文件工具      │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │ Core Utils   │  │ Postprocess  │  │ Visualization │                │
│  │ 核心工具      │  │ 后处理       │  │ 可视化        │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
└─────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        注册表层 (Registry Layer)                        │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │  Registry System                                               │    │
│  │  ├─ TASKS, MODELS, DATASETS                                   │    │
│  │  ├─ RUNNERS, PARTITIONERS                                      │    │
│  │  ├─ ICL_INFERENCERS, ICL_EVALUATORS                           │    │
│  │  └─ PERF_METRIC_CALCULATORS                                   │    │
│  └──────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 详细描述

#### 1. 用户接口层 (CLI Layer)

职责：处理用户输入，解析参数，管理配置

- ArgumentParser
  - 解析命令行参数
  - 验证参数合法性
  - 提供帮助信息
- ConfigManager
  - 加载和合并配置文件
  - 支持配置文件搜索
  - 配置验证和转换
- TaskManager
  - 协调整个评测流程
  - 根据模式选择工作流
  - 初始化工作流执行器

#### 2. 工作流层 (Workflow Layer)

职责：定义评测流程，组织各阶段执行

- WorkFlowExecutor
  - 按顺序执行工作流阶段
  - 管理阶段间数据传递
- 工作流阶段
  - Infer：推理阶段
  - Eval：评估阶段
  - Perf：性能计算阶段
  - Summarize：结果汇总阶段

#### 3. 分区器层 (Partitioner Layer)

职责：将评测任务分解为可执行的子任务

- BasePartitioner：分区器基类
- NaivePartitioner：简单分区（每个模型-数据集对为一个任务）
- SizePartitioner：按大小分区
- SubPartitioner：子任务分区

#### 4. 运行器层 (Runner Layer)

职责：执行任务，管理并行，监控进度

- BaseRunner：运行器基类
- LocalRunner：本地运行器
  - 多进程/多线程并行
  - GPU 资源分配
  - 任务状态监控
- TasksMonitor：任务监控
  - 实时进度显示
  - 状态更新
  - 日志收集

#### 5. 任务层 (Task Layer)

职责：封装具体评测任务逻辑

- BaseTask：任务基类
  - 定义任务接口
  - 管理任务状态
  - 提供日志和输出路径
- OpenICLApiInferTask：服务化推理任务
  - 多进程并发推理
  - 共享内存管理
  - 流式/非流式支持
- OpenICLInferTask：本地推理任务
  - 本地模型推理
  - 批处理支持
- OpenICLEvalTask：评估任务
  - 精度计算
  - 结果对比
  - 指标统计

#### 6. 模型层 (Model Layer)

职责：提供统一的模型接口，适配不同后端

- BaseModel：模型基类
- API Models（服务化）
  - BaseAPIModel：API 模型基类
  - VLLMCustomAPI：vLLM 适配
  - TritonCustomAPI：Triton 适配
  - TGICustomAPI：TGI 适配
  - MindieStreamApi：MindIE 适配
- Local Models（本地）
  - HuggingFacewithChatTemplate：HF 模型
  - VLLMOfflineVLModel：vLLM 离线模型

#### 7. 数据集层 (Dataset Layer)

职责：数据集加载、预处理、格式化

- BaseDataset：数据集基类
- 开源数据集：GSM8K、MMLU 等
- 合成数据集：SyntheticDataset
- 自定义数据集：用户自定义格式

#### 8. OpenICL 层

职责：推理和评估的核心逻辑

- ICL Inferencer（推理器）
  - BaseInferencer：推理器基类
  - BaseApiInferencer：API 推理器
  - GenInferencer：生成式推理
  - PPLInferencer：困惑度推理
  - MultiturnInferencer：多轮对话推理
- ICL Evaluator（评估器）
  - BaseEvaluator：评估器基类
  - 各种精度评估器
- ICL Dataset Reader：数据集读取器
- ICL Prompt Template：提示词模板

#### 9. 结果汇总层 (Summarizer Layer)

职责：汇总评测结果，生成报告

- DefaultSummarizer：默认汇总器（精度）
- DefaultPerfSummarizer：性能汇总器
- DefaultSubjectiveSummarizer：主观评估汇总器

#### 10. 工具支撑层 (Utils Layer)

职责：提供通用工具和辅助功能

- Config Utils：配置处理工具
- Logging：日志系统
- File Utils：文件操作
- Core Utils：核心工具（abbr、types 等）
- Postprocess：后处理工具
- Visualization：可视化工具

#### 11. 注册表层 (Registry Layer)

职责：模块注册与发现，支持插件化扩展

- Registry System：基于 MMEngine 的注册表
- 支持的注册类型：
  - TASKS、MODELS、DATASETS
  - RUNNERS、PARTITIONERS
  - ICL_INFERENCERS、ICL_EVALUATORS
  - PERF_METRIC_CALCULATORS

### 数据流向

```
用户命令
  ↓
CLI层：参数解析、配置加载
  ↓
工作流层：选择工作流（Infer/Eval/Perf）
  ↓
分区器层：任务分解
  ↓
运行器层：任务调度、并行执行
  ↓
任务层：具体任务执行
  ↓
模型层 + 数据集层 + OpenICL层：推理/评估
  ↓
结果汇总层：结果汇总
  ↓
输出结果文件
```

### 关键设计模式

1. 注册表模式：模块通过注册表注册和发现
2. 策略模式：不同模型、数据集、评估器可替换
3. 模板方法模式：BaseTask、BaseRunner 定义流程骨架
4. 工厂模式：通过配置构建对象
5. 观察者模式：TasksMonitor 监控任务状态

该逻辑视图展示了 AISBench 的分层架构，各层职责清晰，通过注册表和配置系统实现模块化与可扩展性。